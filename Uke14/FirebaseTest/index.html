<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        #chat {
            border: 2px solid black;
            height: 500px;
        }
    </style>
</head>
<body>
    <div id="chat1">
        <ul id="chat">

        </ul>
    </div>
    <input type="text" id="name" value="name"/>
    <input type="text" id="inputField" value="message" />
    <button class="submitButton" onclick="writeChat()">Submit</button>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>-->
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-firestore.js"></script>
    <script>
        var config = {
            apiKey: "AIzaSyBuX8JXDmNLolyuF6Q0P5U9CT66DG_Lo_4",
            authDomain: "testing-av-firebase-5acb5.firebaseapp.com",
            databaseURL: "https://testing-av-firebase-5acb5.firebaseio.com",
            projectId: "testing-av-firebase-5acb5",
            storageBucket: "testing-av-firebase-5acb5.appspot.com",
            messagingSenderId: "98873862790"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();
        const settings = {/* your settings... */ timestampsInSnapshots: true};
        db.settings(settings);
        let chatLog = [];
        let chatRooms = db.collection('chatrooms');
        let room1 = chatRooms.doc('buzHycgehxiq9RRhu5W6').collection('messages');
        writeToScreen();

        //=================================================================================================================
        // Functions
        //=================================================================================================================

        Date.prototype.today = function () { 
            return ((this.getDate() < 10)?"0":"") + this.getDate() +"/"+(((this.getMonth()+1) < 10)?"0":"") + (this.getMonth()+1) +"/"+ this.getFullYear();
        }

        // For the time now
        Date.prototype.timeNow = function () {
             return ((this.getHours() < 10)?"0":"") + this.getHours() +":"+ ((this.getMinutes() < 10)?"0":"") + this.getMinutes() +":"+ ((this.getSeconds() < 10)?"0":"") + this.getSeconds();
        }

        function writeChat() {
            writeToScreen();
            writeToBase(room1);
        }
        /*
        function escape(inputString) {
            let dict = [
                {'<': '&lt;'},
                {'>': '&gt;'}
            ];
            let words = inputString.split("");
            
            for (let i of dict) {
                console.log(Object.keys(i)[0]);
                words.splice(words.indexOf(Object.keys(i)[0]), 1, dict.Object.keys(i)[0]);
            }
            output = '';
            //words.map(i => output += i);
            return words;
        }
        */
        function writeToBase(room) {
            let usrId = encodeURI(document.getElementById('name').value);
            let usrVal = encodeURI(document.getElementById('inputField').value);
            let timeVal = new Date().today() + " @ " + new Date().timeNow();
            room.doc('message' + Math.floor(Math.random() * 999999999999)).set({
                time: timeVal,
                usr: usrId,
                message: usrVal
            })
                .then(writeChatBase)
                .catch(writeChatBase);
        }

        function writeToScreen() {
            // Enumerate through all rooms and write to screen
            document.getElementById('chat').innerHTML = '';
            room1.get().then(readChatBase).then(function () {
                for (msg of chatLog) {
                    document.getElementById('chat').innerHTML += '<li>' + msg.timestamp + '\t' + msg.user + ' said: ' + msg.message + '</li>'
                }

            });
        }

        //=================================================================================================================
        // Callbacks
        //=================================================================================================================

        function getResponse(response, error) {
            // ReturnValue is the data given back by firestore when executing the callback.
            // This function logs all data in the database... 
            if (error) {
                throw error;
            } else {
                console.log(response)
                response.forEach(i => console.log(i.data()));
            }
        }

        function readChatBase(response, error) {
            //Reads the content of the chat database and writes it to the page
            console.log('read chat');
            if (!response) {
                console.log('Got nothing back...');
            } else {
                if (error) {
                    throw error;
                } else {
                    chatLog = [];
                    console.log('Got something', response);
                    response.forEach(
                        function (element) {
                            console.log(element.data());
                            chatLog.push({
                                user: element.data().usr,
                                timestamp: element.data().time,
                                message: element.data().message
                            });
                        });

                }
            }
        }

        function writeChatBase(error) {
            if (error) {
                throw error;
            } else {
                console.log('Write operation complete');
            }
        }
    </script>
</body>
</html>